"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj;};}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}return _typeof(obj);}Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _react=_interopRequireWildcard(require("react"));var _semanticUiReact=require("semantic-ui-react");var _Editor=_interopRequireDefault(require("./Editor"));var _Markdown=_interopRequireDefault(require("./Markdown"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _getRequireWildcardCache(nodeInterop){if(typeof WeakMap!=="function")return null;var cacheBabelInterop=new WeakMap();var cacheNodeInterop=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop;})(nodeInterop);}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj;}if(obj===null||_typeof(obj)!=="object"&&typeof obj!=="function"){return{default:obj};}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj);}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(key!=="default"&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}newObj.default=obj;if(cache){cache.set(obj,newObj);}return newObj;}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly){symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});}keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function");}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call;}else if(call!==void 0){throw new TypeError("Derived constructors may only return object or undefined");}return _assertThisInitialized(self);}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}var FormFieldList=function(_Component){_inherits(FormFieldList,_Component);var _super=_createSuper(FormFieldList);function FormFieldList(_ref){var _this;var defaultValue=_ref.defaultValue;_classCallCheck(this,FormFieldList);_this=_super.call(this);_this.addNewValue=_this.addNewValue.bind(_assertThisInitialized(_this));_this.handleInputChange=_this.handleInputChange.bind(_assertThisInitialized(_this));_this.state={values:defaultValue};return _this;}_createClass(FormFieldList,[{key:"getDefaultNewValue",value:function getDefaultNewValue(){var type=this.props.type;switch(type||type.slice(0,-1)){case'String':return'';case'Int':return 0;case'Float':return 0.0;case'Boolean':return true;default:return'';}}},{key:"addNewValue",value:function addNewValue(){this.state.values.push(this.getDefaultNewValue());this.setState({values:this.state.values});}},{key:"handleInputChange",value:function handleInputChange(idx,value){this.state.values[idx]=value;this.setState({values:this.state.values});}},{key:"render",value:function render(){var _this2=this;var _this$props=this.props,label=_this$props.label,control=_this$props.control,type=_this$props.type,id=_this$props.id,defaultValue=_this$props.defaultValue,onInput=_this$props.onInput,disabled=_this$props.disabled,placeholder=_this$props.placeholder;return _react.default.createElement("div",null,_react.default.createElement("label",null,label," ",_react.default.createElement(_semanticUiReact.Icon,{name:"add",onClick:this.addNewValue,color:'green'})),_react.default.createElement("div",{id:id},this.state.values.map(function(value,idx){var _React$createElement;return _react.default.createElement(_semanticUiReact.Form.Field,{key:idx},_react.default.createElement(_semanticUiReact.Form.Input,(_React$createElement={placeholder:"First Name",type:type,value:_this2.state.values[idx],onInput:onInput,disabled:disabled},_defineProperty(_React$createElement,"placeholder",placeholder),_defineProperty(_React$createElement,"action",_react.default.createElement(_semanticUiReact.Button,{onClick:function onClick(){_this2.state.values.splice(idx,1);_this2.setState({values:_this2.state.values});},color:"blue"},"x")),_defineProperty(_React$createElement,"onChange",function onChange(event){_this2.handleInputChange(idx,event.target.value);}),_React$createElement)));})));}}]);return FormFieldList;}(_react.Component);var View=function(_Component2){_inherits(View,_Component2);var _super2=_createSuper(View);function View(){var _this3;_classCallCheck(this,View);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this3=_super2.call.apply(_super2,[this].concat(args));_this3.getOptionsForModal=_this3.getOptionsForModal.bind(_assertThisInitialized(_this3));_this3.addSelectOption=_this3.addSelectOption.bind(_assertThisInitialized(_this3));_this3.generateModal=_this3.generateModal.bind(_assertThisInitialized(_this3));_this3.getSelectData=_this3.getSelectData.bind(_assertThisInitialized(_this3));_this3.generateFields=_this3.generateFields.bind(_assertThisInitialized(_this3));_this3.checkIfDisabled=_this3.checkIfDisabled.bind(_assertThisInitialized(_this3));_this3.getPopupImgPath=_this3.getPopupImgPath.bind(_assertThisInitialized(_this3));_this3.initStatesForSelector=_this3.initStatesForSelector.bind(_assertThisInitialized(_this3));_this3.editText=_this3.editText.bind(_assertThisInitialized(_this3));_this3.update=_this3.update.bind(_assertThisInitialized(_this3));_this3.state={schema:_this3.props.schema,fields:_this3.props.fields,data:_this3.props.data,dataErrors:_this3.props.dataErrors,currentItemId:_this3.props.currentItemId,popupImgLink:false};_this3.initStatesForSelector(_this3.props.fields);return _this3;}_createClass(View,[{key:"componentDidMount",value:function componentDidMount(){var _this$state=this.state,fields=_this$state.fields,data=_this$state.data;this.getSelectData(fields,data);}},{key:"UNSAFE_componentWillReceiveProps",value:function UNSAFE_componentWillReceiveProps(nextProps){this.setState({data:nextProps.data,dataErrors:nextProps.dataErrors,currentItemId:nextProps.currentItemId});}},{key:"getDateValue",value:function getDateValue(arg){var date=new Date(arg);var y="0000".concat(date.getFullYear()).slice(-4);var m="00".concat(date.getMonth()+1).slice(-2);var d="00".concat(date.getDate()).slice(-2);return"".concat(y,"-").concat(m,"-").concat(d);}},{key:"getSelectData",value:function getSelectData(fields,data){var _this4=this;fields.forEach(function(field){var propName=Object.keys(field)[0];if(field[propName].inputControl==='selection'){var _this4$setState2;var options=[];var defaultOptions=[];var dataForOptions=[];var label=field[propName].list.label?field[propName].list.label:Object.keys(field[propName].nestedFields[1])[0];var hasOwnAPI=false;if(Object.keys(field[propName].list.resolvers.find.args).length!==0&&(field[propName].list.resolvers.create&&Object.keys(field[propName].list.resolvers.create.args).length!==0||field[propName].list.resolvers.update&&Object.keys(field[propName].list.resolvers.update.args).length!==0)){hasOwnAPI=true;}if(!hasOwnAPI&&data){data[propName].forEach(function(obj,idx){defaultOptions.push(idx);dataForOptions.push(obj);options.push({text:obj[label],value:idx});});}else if(hasOwnAPI){var resolver=field[propName].list.resolvers.find.resolver;var request=_this4.props.getRequestString(field[propName].nestedFields);_this4.props.query('query',request,resolver).then(function(res){res.data[field[propName].list.resolvers.find.resolver].forEach(function(obj,idx){dataForOptions.push(obj);options.push({text:obj[label],value:idx});var statement;if(data){data[propName].forEach(function(item){if(Object.prototype.hasOwnProperty.call(item,'id')){statement=item.id===obj.id;}else if(Object.prototype.hasOwnProperty.call(item,'_id')){statement=item._id===obj._id;}if(data&&statement)defaultOptions.push(idx);});}});_this4.setState(_defineProperty({},"".concat(propName,"DefaultValue"),defaultOptions),function(){return setTimeout(function(){return _this4.refs[propName].forceUpdate();},1);});}).catch(function(err){throw new Error("".concat(propName,", getSelectData, error: ").concat(err));});}_this4.setState((_this4$setState2={},_defineProperty(_this4$setState2,"".concat(propName,"DefaultValue"),defaultOptions),_defineProperty(_this4$setState2,"".concat(propName,"Data"),dataForOptions),_defineProperty(_this4$setState2,propName,options),_this4$setState2),function(){return setTimeout(function(){return _this4.refs[propName].forceUpdate();},1);});}});}},{key:"getOptionsForModal",value:function getOptionsForModal(e,fields){e.preventDefault();this.getSelectData(fields);}},{key:"getPopupImgPath",value:function getPopupImgPath(propName){if(propName){var p=document.getElementById("".concat(propName,"-p"));var uploadPath=this.props.schema.uploadPath?this.fixPath(this.props.schema.uploadPath):this.props.schema.typeName;this.setState({popupImgLink:"".concat(uploadPath,"/").concat(p.innerText)});}}},{key:"fixPath",value:function fixPath(string){var response='';if(string.slice(0,1)==='/'||string.slice(0,1)==='.'){response=string;}else{response="/".concat(string);}if(response.slice(-1)==='/'){response=response.slice(0,-1);}return response;}},{key:"isDate",value:function isDate(val){var d=new Date(val);return!isNaN(d.valueOf())&&typeof val!=='boolean'&&typeof val!=='number'&&typeof+val!=='number';}},{key:"addSelectOption",value:function addSelectOption(e,_ref2){var _this$setState;var label=_ref2.label,fields=_ref2.fields;var propName=e.currentTarget.name;var data=this.props.collectFieldsData(fields,false,false,propName);var newState=this.state[propName];var newData=this.state["".concat(propName,"Data")]?this.state["".concat(propName,"Data")]:[];newState.push({text:label?data[label]:data[Object.keys(data)[1]],value:+newState.length});newData.push(data);this.setState((_this$setState={},_defineProperty(_this$setState,propName,newState),_defineProperty(_this$setState,"".concat(propName,"Data"),newData),_this$setState),function(){document.querySelector('.modals').click();});}},{key:"checkIfDisabled",value:function checkIfDisabled(field,propName){var method=false;var schema=this.state.schema;if(schema.resolvers.update){method=schema.resolvers.update.args;}else if(schema.resolvers.create){method=schema.resolvers.create.args;}var result=method&&method[propName]?field[propName].disabled:true;return result;}},{key:"checkOnEnterIfTextarea",value:function checkOnEnterIfTextarea(e){if(e.target.nodeName==='INPUT'&&e.target.value.length>100){var textarea=document.createElement('textarea');textarea.id=e.target.id;textarea.placeholder=e.target.placeholder;textarea.innerText=e.target.value;e.target.parentNode.insertBefore(textarea,e.target);e.target.parentNode.removeChild(e.target);document.getElementById(textarea.id).focus();}}},{key:"initStatesForSelector",value:function initStatesForSelector(fields){var _this5=this;fields.forEach(function(field){if(field[Object.keys(field)[0]].inputControl==='selection'){_this5.state[Object.keys(field)[0]]=[];}});}},{key:"generateModal",value:function generateModal(fields,propName){var _this6=this;var to=(fields[propName].nestedFields.length/2).toFixed(0);var from=fields[propName].nestedFields.length-to;return _react.default.createElement(_semanticUiReact.Modal,{id:"".concat(propName,"Modal"),trigger:_react.default.createElement(_semanticUiReact.Button,{icon:true,className:"selector-add",onClick:function onClick(e){return _this6.getOptionsForModal(e,fields[propName].nestedFields);}},_react.default.createElement(_semanticUiReact.Icon,{name:"plus"})),className:"graphql-cms_modal graphql-cms"},_react.default.createElement(_semanticUiReact.Modal.Header,null,"Add new select option for \"",propName,"\"",_react.default.createElement("div",{className:"btn-row"},_react.default.createElement(_semanticUiReact.Button,{type:"submit",color:"black",name:propName,onClick:function onClick(e){return _this6.addSelectOption(e,{fields:fields[propName].nestedFields,label:fields[propName].list.label});}},"add"))),_react.default.createElement(_semanticUiReact.Modal.Content,null,_react.default.createElement(_semanticUiReact.Grid,{as:_semanticUiReact.Form},_react.default.createElement(_semanticUiReact.Grid.Column,{computer:8,mobile:16},fields[propName].nestedFields.slice(0,to).map(function(field,idx){return _this6.generateFields(field,idx,false,false,"".concat(propName,"/"));})),_react.default.createElement(_semanticUiReact.Grid.Column,{computer:8,mobile:16},fields[propName].nestedFields.slice(-from).map(function(field,idx){return _this6.generateFields(field,idx,false,false,"".concat(propName,"/"));})))));}},{key:"editText",value:function editText(node){this.setState({editText:node});}},{key:"update",value:function update(){this.setState({editText:null});this.props.update();}},{key:"generateFields",value:function generateFields(obj,idx,data,dis,prefix){var _this7=this;var pr=prefix||'';var fields=_objectSpread({},obj);var propName=Object.keys(fields)[0];var popupImgLink=this.state.popupImgLink;var value='';var checked='';var dateInput=false;var disabled=typeof dis==='boolean'?dis:this.checkIfDisabled(fields,propName);var required=/!$/.test('something');var control=fields[propName].inputControl;var DOM;if(fields[propName].nestedFields&&fields[propName].nestedFields[0]&&fields[propName].inputControl!=='selection'){disabled=fields[propName].disabled;var newData=data?data[propName]:false;return _react.default.createElement("div",{className:"nestedFields",key:idx},_react.default.createElement(_semanticUiReact.Divider,{horizontal:true},propName," ",_react.default.createElement(_semanticUiReact.Icon,{name:"level down"})),fields[propName].nestedFields.map(function(fields,index){return _this7.generateFields(fields,index+300,newData,disabled,"".concat(propName,"/"));}),_react.default.createElement(_semanticUiReact.Divider,{horizontal:true},propName," ",_react.default.createElement(_semanticUiReact.Icon,{name:"level up"})));}if(data&&(data[propName]||typeof data[propName]==='boolean')&&fields[propName].inputType!=='file'){value=data[propName];if(value.length>100){control='textarea';}}else{value='';}if(data&&fields[propName].inputType==='checkbox'){checked=!data?false:data[propName];}else{checked=false;}if(this.isDate(value)||propName==='createdAt'||propName==='updatedAt'||propName==='deletedAt'||fields[propName].inputType==='date'){dateInput='date';value=!data?'':this.getDateValue(value);}var type=dateInput||fields[propName].inputType;if(data||propName!=='id'&&propName!=='_id'&&propName!=='offset'&&propName!=='limit'){if(type==='file'){DOM=_react.default.createElement("div",{className:"file-form",key:idx},_react.default.createElement(_semanticUiReact.Button,{as:"label",content:fields[propName].label,className:"file-form-btn",icon:"upload",disabled:disabled,labelPosition:"right",htmlFor:"".concat(pr).concat(propName,"-input")}),_react.default.createElement(_semanticUiReact.Popup,{onMount:function onMount(){return _this7.getPopupImgPath(propName);},onClose:function onClose(){return _this7.getPopupImgPath(false);},name:propName,trigger:_react.default.createElement("p",{className:"file-name",id:"".concat(pr).concat(propName,"-p")},data[propName])},_react.default.createElement("img",{id:"".concat(pr).concat(propName,"-img"),src:popupImgLink,alt:propName})),_react.default.createElement("input",{disabled:disabled,onChange:this.props.uploadImage,id:"".concat(pr).concat(propName,"-input"),type:"file"}));}else if(fields[propName].inputControl==='selection'){var options=this.state[propName];var hasOwnAPI=false;if(Object.keys(fields[propName].list.resolvers.find.args).length!==0&&(fields[propName].list.resolvers.create&&Object.keys(fields[propName].list.resolvers.create.args).length!==0||fields[propName].list.resolvers.update&&Object.keys(fields[propName].list.resolvers.update.args).length!==0)){hasOwnAPI=true;}DOM=_react.default.createElement("div",{className:"file-form",key:idx},_react.default.createElement("label",null,fields[propName].label),!hasOwnAPI?this.generateModal(fields,propName):null,options&&Array.isArray(this.state["".concat(propName,"DefaultValue")])?_react.default.createElement(_semanticUiReact.Dropdown,{ref:propName,placeholder:fields[propName].label,id:"".concat(pr).concat(propName),fluid:true,multiple:true,selection:true,search:true,defaultValue:this.state["".concat(propName,"DefaultValue")],options:options}):null);}else if(type==='markdown'){DOM=_react.default.createElement(_Markdown.default,{key:idx,id:"".concat(pr).concat(propName),value:value,label:fields[propName].label,onEdit:this.editText});}else if(fields[propName].list===true){DOM=_react.default.createElement(FormFieldList,{key:idx,label:fields[propName].label,control:control,type:type,id:"".concat(pr).concat(propName),defaultValue:value,defaultChecked:checked,onInput:this.checkOnEnterIfTextarea,disabled:disabled,placeholder:propName});}else{DOM=_react.default.createElement(_semanticUiReact.Form.Field,{key:idx,label:fields[propName].label,control:control,type:type,id:"".concat(pr).concat(propName),defaultValue:value,defaultChecked:checked,onInput:this.checkOnEnterIfTextarea,disabled:disabled,placeholder:propName});}}return DOM;}},{key:"render",value:function render(){var Column=_semanticUiReact.Grid.Column;var _this$state2=this.state,fields=_this$state2.fields,schema=_this$state2.schema,currentItemId=_this$state2.currentItemId,data=_this$state2.data,dataErrors=_this$state2.dataErrors;var _this$props2=this.props,update=_this$props2.update,remove=_this$props2.remove,addNewItem=_this$props2.addNewItem;var generateFields=this.generateFields;var to=(fields.length/2).toFixed(0);var from=fields.length-to;return _react.default.createElement("div",null,this.state.editText?_react.default.createElement(_Editor.default,{element:this.state.editText,upload:this.props.uploadFile,path:this.props.schema.uploadPath?this.fixPath(this.props.schema.uploadPath):this.props.schema.typeName}):null,_react.default.createElement(_semanticUiReact.Segment,{color:"black",className:"View"},dataErrors&&dataErrors.length>0?_react.default.createElement(_semanticUiReact.Message,{negative:true,compact:true,style:{position:'relative',width:'auto',display:'block',left:'auto',top:'auto',textAlign:'left',margin:'10px'}},_react.default.createElement(_semanticUiReact.Message.Header,null,"Error with GraphQL Data Returned"),_react.default.createElement("ul",null,dataErrors.map(function(error){return _react.default.createElement("li",{key:error.message},error.message);}))):null,_react.default.createElement("div",{className:"btn-row"},currentItemId?_react.default.createElement(_semanticUiReact.Button,{type:"submit",color:"black",onClick:addNewItem,disabled:!schema.resolvers.create||!schema.resolvers.create.allowed},"add new"):null,_react.default.createElement(_semanticUiReact.Button,{type:"submit",color:"black",onClick:!schema.resolvers.update?null:this.update,disabled:!schema.resolvers.update||!schema.resolvers.update.allowed},"save"),_react.default.createElement(_semanticUiReact.Button,{type:"submit",color:"black",id:currentItemId,onClick:!schema.resolvers.remove?null:remove,disabled:!schema.resolvers.remove||!schema.resolvers.remove.allowed},"remove")),_react.default.createElement(_semanticUiReact.Grid,{as:_semanticUiReact.Form},_react.default.createElement(_semanticUiReact.Grid.Row,{columns:2},_react.default.createElement(Column,{computer:8,mobile:16},fields.slice(0,to).map(function(field,idx){return generateFields(field,idx,data);})),_react.default.createElement(Column,{computer:8,mobile:16},fields.slice(-from).map(function(field,idx){return generateFields(field,idx,data);}))),_react.default.createElement(_semanticUiReact.Grid.Row,null,_react.default.createElement(_semanticUiReact.Grid.Column,null,_react.default.createElement(_semanticUiReact.Container,null))),_react.default.createElement(_semanticUiReact.Grid.Row,null))));}}]);return View;}(_react.Component);var _default=View;exports.default=_default;